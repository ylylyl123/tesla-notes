# Tesla Notes 部署与性能优化记录

**日期**: 2026-02-13  
**时间**: 23:36 ~ 00:49  
**项目**: Tesla Notes (Zac卓越之道)  
**仓库**: <https://github.com/ylylyl123/tesla-notes>  
**公网地址**: <https://ylylyl123.github.io/tesla-notes/>

---

## 一、GitHub 仓库部署

### 1.1 问题

项目需要推送到 GitHub 并部署到公网，但 `gh auth login` 登录不上。

### 1.2 解决方案：SSH Key + 443 端口

由于 SSH 22 端口被网络封锁，`gh auth login` 也无法弹出浏览器授权，采用以下流程：

#### 步骤 1：生成 SSH Key

```bash
mkdir -p ~/.ssh
ssh-keygen -t ed25519 -C "2022361001@email.szu.edu.cn" -f ~/.ssh/id_ed25519 -N ""
```

#### 步骤 2：配置 SSH 走 443 端口（绕过 22 端口封锁）

```bash
cat > ~/.ssh/config << 'EOF'
Host github.com
  Hostname ssh.github.com
  Port 443
  User git
  IdentityFile ~/.ssh/id_ed25519
EOF
chmod 600 ~/.ssh/config
```

#### 步骤 3：在 GitHub 网页添加公钥

- 地址: <https://github.com/settings/keys>
- 添加 `~/.ssh/id_ed25519.pub` 的内容

#### 步骤 4：测试连接

```bash
ssh -T git@github.com
# 输出: Hi ylylyl123! You've successfully authenticated
```

#### 步骤 5：推送代码

```bash
git remote add origin git@github.com:ylylyl123/tesla-notes.git
git push -u origin main
```

### 1.3 .gitignore 安全配置

确保以下敏感文件不被上传：

```
.env
.env.*
!.env.example
*.db
memo.json
daily_plan.json
exports/
*.app/
```

---

## 二、GitHub Pages 自动部署

### 2.1 为什么选 GitHub Pages 而不是 Vercel

- Vercel CLI 也需要浏览器登录，同样卡住
- GitHub Pages 可以通过 `gh` CLI 全自动配置
- 不需要额外注册账号

### 2.2 创建 GitHub Actions Workflow

文件：`.github/workflows/deploy.yml`

```yaml
name: Deploy to GitHub Pages
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Build
        run: pnpm build
        env:
          GITHUB_PAGES: 'true'
          VITE_DATA_MODE: cloud
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      - run: cp dist/index.html dist/404.html  # SPA 路由支持
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/deploy-pages@v4
```

### 2.3 Vite 配置修改

`vite.config.ts` 中添加 GitHub Pages base 路径：

```typescript
const isGitHubPages = process.env.GITHUB_PAGES === 'true';

export default defineConfig(async () => ({
  base: isGitHubPages ? '/tesla-notes/' : '/',
  // ...
}));
```

### 2.4 GitHub CLI 配置

#### 登录 gh（设备码方式）

```bash
gh auth login --hostname github.com --git-protocol ssh --skip-ssh-key
# 打开 https://github.com/login/device 输入设备码
```

#### 设置 Secrets

```bash
gh secret set VITE_SUPABASE_URL --body "https://syrnyjdoqsrzdhzkkopu.supabase.co" --repo ylylyl123/tesla-notes
gh secret set VITE_SUPABASE_ANON_KEY --body "sb_publishable_..." --repo ylylyl123/tesla-notes
```

#### 仓库改为公开（免费版 Pages 要求）

```bash
gh repo edit ylylyl123/tesla-notes --visibility public --accept-visibility-change-consequences
```

#### 启用 Pages

```bash
gh api repos/ylylyl123/tesla-notes/pages -X POST -f build_type=workflow
```

### 2.5 部署结果

- 构建时间: ~20-30s
- 部署时间: ~8-10s
- 每次 `git push` 自动触发重新部署

---

## 三、性能优化

### 3.1 问题

- 网页首次加载数据需要 ~10 秒
- 新增笔记后 ~10 秒才显示
- 整体交互体验迟钝

### 3.2 根本原因诊断

| 瓶颈 | 描述 |
|------|------|
| **无乐观更新** | 所有写操作都 await 远程写入 → await 全量重新查询 → 更新 UI，两次网络往返 |
| **Supabase 客户端无超时** | 默认连接无超时控制，慢连接阻塞 |
| **查询无索引** | `getMemos()` 的 WHERE + ORDER BY 没有对应索引 |

### 3.3 优化方案与实现

#### 优化 1：乐观更新（Optimistic UI）— 最关键

修改 `App.tsx` 中 5 个写操作（`createMemo`, `deleteMemo`, `updateMemo`, `toggleStatus`, `togglePin`），改为先立即更新本地 state，再后台异步同步远程。

**示例 — createMemo 改造后：**

```typescript
const createMemo = async () => {
  if (!newMemoContent.trim()) return;
  const tempId = -Date.now();
  const tempMemo = { id: tempId, content: newMemoContent, ... };
  
  // 立即更新 UI（0ms 延迟）
  setMemos((prev) => [tempMemo, ...prev]);
  setNewMemoContent("");
  
  try {
    const created = await getDataClient().createMemo({...});
    // 用真实数据替换临时数据
    setMemos((prev) => prev.map((m) => (m.id === tempId ? created : m)));
  } catch (error) {
    // 失败回滚
    setMemos((prev) => prev.filter((m) => m.id !== tempId));
  }
};
```

#### 优化 2：Supabase 客户端配置

修改 `cloudClient.ts`：

```typescript
supabase = createClient(url, anonKey, {
  realtime: {
    params: { eventsPerSecond: 10 },
  },
  global: {
    fetch: (input, init) => {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);
      return fetch(input, { ...init, signal: controller.signal })
        .finally(() => clearTimeout(timeout));
    },
  },
});
```

#### 优化 3：数据库索引

在 Supabase SQL Editor 中执行：

```sql
CREATE INDEX IF NOT EXISTS idx_memo_list
  ON public.memo (archived, pinned DESC, created_ts DESC);
```

### 3.4 尝试但撤回的方案：localStorage 缓存

- **思路**: 将笔记缓存到 localStorage，打开页面时先显示缓存数据
- **问题**: 笔记中包含大量 base64 图片，JSON 超过 localStorage 5MB 限制导致缓存失败
- **尝试修复**: 缓存时剥离 base64 图片数据 → 但导致图片显示为"附图"占位符
- **结论**: 体验不好，**已撤回**

### 3.5 最终优化效果

| 操作 | 优化前 | 优化后 |
|------|--------|--------|
| 新增笔记 | ~10s | **瞬间** ✅ |
| 删除笔记 | ~10s | **瞬间** ✅ |
| 编辑笔记 | ~10s | **瞬间** ✅ |
| 切换状态/置顶 | ~10s | **瞬间** ✅ |
| 首次加载 | ~5-10s | ~5-10s（Supabase 网络延迟，无法避免） |

---

## 四、Git 提交记录

```
56c9fd8 revert: 移除 localStorage 缓存，避免图片显示异常
2b97e84 fix: 缓存剥离 base64 图片数据，修复 localStorage 溢出导致缓存失效
24f02fe perf: 添加 localStorage 缓存，打开页面瞬间显示数据
927720d perf: 乐观更新 + Supabase 客户端优化 + 数据库索引
5c63f05 perf: enable realtime cloud sync and lazy image loading
0717b33 feat: 添加 GitHub Pages 自动部署 (GitHub Actions)
a036313 feat: add cloud sync workflow, mobile UX, and deployment configs
```

---

## 五、关键文件清单

| 文件 | 作用 |
|------|------|
| `.github/workflows/deploy.yml` | GitHub Actions 自动部署 |
| `src/App.tsx` | 主组件（乐观更新逻辑） |
| `src/services/cloudClient.ts` | Supabase 客户端（超时+Realtime 配置） |
| `src/services/dataClient.ts` | 数据模式切换（auto/local/cloud） |
| `supabase_schema.sql` | 数据库表结构 + 索引 |
| `vite.config.ts` | GitHub Pages base 路径配置 |
| `.env.example` | 环境变量模板 |
| `vercel.json` / `netlify.toml` | 备用部署配置 |

---

## 六、后续可做的事

1. **Supabase 区域迁移** — 如果将项目迁到新加坡节点，首次加载速度会显著提升
2. **图片存储优化** — 将 base64 图片改为上传到 Supabase Storage，用 URL 引用，减少数据传输量
3. **PWA 配置** — 添加 Service Worker 和 manifest.json，让手机"添加到主屏幕"体验更好
4. **自定义域名** — 可以在 GitHub Pages 设置中绑定自己的域名
